var footerheight;function getDocHeight(){footerheight=footerheight||$("footer").height();var t=document;return Math.max(t.body.scrollHeight,t.documentElement.scrollHeight,t.body.offsetHeight,t.documentElement.offsetHeight,t.body.clientHeight,t.documentElement.clientHeight)-footerheight}function didHitBottom(t){return(t=t||0)+$(window).scrollTop()+$(window).height()>=getDocHeight()}$(function(){var i=!0,e=$("#albumWrapper");if(!e.length)return!1;$.extend($.expr[":"],{inview:function(t){var n=$(t),i=$(arguments[1]),e=i.scrollLeft(),o=n.position().left-1+e,a=e+i.width();return e<o&&o<a},outview:function(t){var n=$(t),i=$(arguments[1]),e=i.scrollLeft(),o=n.position().left+e+n.width(),a=e+i.width();return e<o&&o<a},containedview:function(t){var n=$(t),i=$(arguments[1]),e=i.scrollLeft(),o=n.position().left+e,a=e+i.width();return n.data("focusfactor",Math.min(o+n.width(),a)-Math.max(o,e)),e<=o&&o<=a||o+n.width()>=e&&o+n.width()<=a},notcontainedenough:function(t){var n=$(t),i=$(arguments[1]),e=i.scrollLeft(),o=n.position().left+e,a=e+i.width();return!(e<=o&&o<=a&&o+n.width()>=e&&o+n.width()<=a)}}),$.fn.focusNext=function(t){if($(this)){var n=$(this).find(".fileitem:"+(t?"outview:first":"inview:last"));if(n&&n.length)n.focusImage($(this),200),$(this).data("lastfocus",n);else{if((n=$(this).find(".fileitem:containedview:first"))&&n.length&&(n=t?n.prev():n.next())&&n.length)return void n.focusImage($(this),200);$(this).animate({scrollLeft:t?0:$(this).prop("scrollWidth")-$(this).width()},200)}}},$.fn.focusImage=function(t,n){if($(this)){var i=parseInt(t.scrollLeft()),e=$(this).position().left+i-t.width()/2+$(this).width()/2;t.animate({scrollLeft:e},n)}};var o=2;$(window).scroll(function(){didHitBottom()&&i&&(i=!1,$.ajax({type:"GET",url:"./albums?page="+o,success:function(t){if(t){var n=$(t);e.append(n);n.find(".pag-scroller").bindScroller(),o++,i=!0,$(window).trigger("scroll")}else i=!1}}))}),$(".fs-album-wrapper").on("click",".pag-col",function(t){var n=$(this).parent().find(".pag-scroller:first"),i=$(this).hasClass("lefter");n.focusNext(i)}),$.fn.bindScroller=function(){var i=$(this);$(this).on("scroll",function(t){var n=i.data("timer");clearTimeout(n),$alls=i.find(".fileitem"),i.data("focused")&&($alls.stop().fadeTo(0,1),i.data("focused",!1)),isBreakPoint(480)?i.data("timer",setTimeout(function(){var t=i.find(".fileitem:containedview");if(t&&t.length){var n=null;t.each(function(t){(!n||$(this).data("focusfactor")&&$(this).data("focusfactor")>n.data("focusfactor"))&&(n=$(this))}),n&&n.focusImage(i,200)}},150)):i.data("timer",setTimeout(function(){var t=i.find(".fileitem:notcontainedenough");t.length!=$alls.length&&(i.data("focused",!0),t.stop().fadeTo(500,.12))},1500))}),$(this).unveil(400)},$(".pag-scroller").bindScroller(),$(window).trigger("scroll")});var isBreakPoint=function(t){for(var n,i,e=[320,480,768,1024],o=$(window).width(),a=0,r=e.length;a<r;a++)if(e[a]===t){n=e[a-1]||0,i=e[a];break}return n<o&&o<=i};function setUrlParam(t,n,i){var e=window.location.href,o="";(e=e.split("#",2))[1]&&(o="#"+e[1]);var a=(e=e[0]).split("?",2);for(var r in t)if(val=encodeURIComponent(t[r]),a[1]&&1<a[1].length)if(-1==e.search(r+"=")){var s="&";a[1].length<2&&(s=""),a=(e+=s+r+"="+val).split("?",2)}else{for(var l=a[1].split("&"),f=0;f<l.length;f++){if(0==l[f].trim().indexOf(r+"=")){l[f]=r+"="+val;break}}a[1]=l.join("&"),e=a[0]+"?"+a[1]}else-1!=e.indexOf("?")?e+="&"+r+"="+val:e+="?"+r+"="+val;if(n){l=a[1].split("&");var c=[];for(f=0;f<l.length;f++){keep=!0;for(var d=0;d<n.length;d++)if(0==l[f].indexOf(n[d])){keep=!1;break}keep&&c.push(l[f])}e=a[0]+"?"+c.join("&")}return e+(!1===i?"":o)}function DropDown(t){this.dd=t,this.initEvents()}DropDown.prototype={initEvents:function(){this.dd.on("click",function(t){$(this).toggleClass("active"),t.stopPropagation()})}},$(function(){new DropDown($(".wrapper-dropdown"));$(document).click(function(){$(".wrapper-dropdown").removeClass("active")})}),$(function(){var f,t=200,e=.75,c=2,d=30,u=0,h=3,p=3,g="%",v=$("body").data("thumburl"),m=$("#fsWrapper .content"),w=m.find("> .fspolar:first");return function r(){f&&clearTimeout(f);var s=0,l=[];w.empty(),$.get($("body").data("path")+"/random?n="+t,function(o){if($.fn.findOutPoint=function(){var t=$(this).outerWidth(),n=$(this).outerHeight(),i=Math.floor(100*Math.random())+1;return Date.now()%2==0&&(i*=-1),{x:i+g,y:-100-t/n*d-d+g}},$.fn.findInPoint=function(){var t=$(this).outerWidth()/m.outerWidth(),n=Math.floor(Math.random()*(1/t)*50*e)+1,i=Math.floor(Math.random()*Math.abs(100-1/e*100))+1;return Date.now()%2==0&&(n*=-1),{x:n+g,y:i+g}},$.fn.nextTransform=function(){var t,n=" rotate("+Math.random()*d*(Date.now()%2?1:-1)+"deg)";return $(this).data("out")?(t=$(this).findInPoint(),n="",$(this).data("out",!1)):(t=$(this).findOutPoint(),$(this).data("out",!0)),"translate("+t.x+", "+t.y+")"+n},$.fn.fly=function(i){return this.each(function(){var t=$(this).nextTransform(),n=i?"none":"transform "+c+"s";$(this).css({transition:n,"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t,transform:t,display:"block"})})},o&&o.length&&v){var a=0;!function t(){if(s>=o.length)return r();var n=o[s++];if(n){var i=$("<img>");function e(){if(w.append($(this)),$(this).fly(!0),$(this).css({"z-index":++a,filter:"none"}),$(this).fly(),u)for(var t=0;t<l.length;t++)l[t].css("filter","blur("+u*(l.length-t)+"px)");if(l.length>=p){var n=l.shift();n&&(n.fly(),setTimeout(function(){n.remove()},1e3*(c+1)))}l.push(i)}i.attr("src",v+n.filename),i.attr("onclick",'javascript:window.location = "./photos?album='+n.album_id+'&by=2"'),i[0].complete?e.call(i[0]):i.on("load",e)}f=setTimeout(t,1e3*h)}()}})}()}),function(l){l.fn.unveil=function(t,e){var n,a=l(this),r=t||0,o=1<window.devicePixelRatio?"data-src-retina":"data-src",i=l(this).find(".fileitem");function s(){var t=i.filter(function(){var t=l(this),n=a.scrollLeft(),i=n+a.width(),e=t.position().left+n,o=e+t.width();return n-r<=o&&e<=i+r});n=t.trigger("unveil"),i=i.not(n)}return i.one("unveil",function(){var t=this,n=this.children[0],i=n.getAttribute(o);(i=i||n.getAttribute("data-src"))&&(n.setAttribute("src",i),n.onload=function(){t.removeChild(t.children[1])},"function"==typeof e&&e.call(n))}),a.on("scroll.unveil resize.unveil lookup.unveil",s),s(),this},l.fn.hitsBottom=function(n,i){var e=l(this);i=i||0,l(window).on("scroll resize",function(t){didHitBottom(i)&&("function"==typeof n&&n.call(window,i),e.trigger("bottomhit"))})}}(window.jQuery||window.Zepto),$(function(){var t=$("#aw_navbar .navbar-links"),n=$("a",t),i=t.find("li.active");n.hover(function(t){n.not(this).addClass("blur"),i.length&&i.removeClass("active")},function(t){n.removeClass("blur"),i.length&&i.addClass("active")})}),$(function(){var f=$("#photosWrapper");if(!f.length)return!1;var c=$(".photo-col"),d=0,i=1,e=!0,u=null,h=[],p=[],g={};c.each(function(t){g[t]=[]}),f.hitsBottom(function(t){o()},400);var t=o();function o(){return!!e&&(e=!1,$.ajax({type:"GET",url:setUrlParam({by:f.data("selectedsort"),seed:f.data("seed"),page:i}),success:function(t){!function(t){{if(t&&t.length){for(var n=0;n<t.length;n++){for(var i=0;i<c.length;i++){var e=$(c[i]);(!u||parseInt(e.data("height"))<parseInt(u.data("height")))&&(u=e)}var o=$(t[n]),a=u.index();o.data("index",d++),o.data("col",a),g[a].push(o),h.push(o);var r={src:o.data("path"),w:o.data("lwidth"),h:o.data("lheight")};p.push(r);var s=parseInt(o.data("height"));u.data("height",parseInt(u.data("height"))+s),m?$(c[0]).append(o):u.append(o);var l=o.find("img:first");l[0]&&(l[0].onload=function(){var t=$(this).next();$(this).parent().css({"margin-bottom":"0px"}),t.length&&t.remove()})}return!0}h.length||f.find(".noresults:first").show()}return!1}(t)?e=!1:(i++,e=!0,$(window).trigger("scroll"))}}))}t&&t.done(function(){o()});var a=$("#pswp"),r=a.find(".viewer-album:first"),s=a.find(".pswp__button--album:first"),l=a.find(".pswp__info:first"),v=null;var m=isBreakPoint(768);function n(){m?$(c[0]).append(h):c.each(function(t){$(this).append(g[t])})}function w(t,n){void 0===n&&(n=100);function i(){a.toggleClass("freeze",l.is(":visible")),a.find(".pswp__button--info:first").toggleClass("active",l.is(":visible"))}v&&("show"==t?l.fadeIn(n,"swing",i):"hide"==t?l.fadeOut(n,"swing",i):l.fadeToggle(n,"swing",i))}$(window).on("resize",function(t){$(window).width()<753&&!m?(m=!0,n()):753<=$(window).width()&&m&&(m=!1,n())}),n(),$.fn.infoup=function(){var t=$(this),n=t.find(".infowrapper:first"),i=t.find("img:first");t.hasClass("infoup")?(n.fadeOut(100),i.removeClass("blurimg"),t.removeClass("infoup")):(n.fadeIn(100),i.addClass("blurimg"),t.addClass("infoup"))},a.on("click",".pswp__button--download",function(t){if(v){var n=v.getCurrentIndex();if(h[n]){var i=h[n].find(".toggle-download:first").attr("href");if(i)return void(document.location=i)}}alert("Could not download image")}),a.on("click",".pswp__button--info",function(t){w("toggle")}),l.on("click",function(t){w("hide")}),f.on("click",".albumname",function(t){t.stopPropagation();var n=parseInt($(this).data("album"));document.location=setUrlParam({album:n})}),f.on("click",".thumb, .toggle-zoom",function(t){t.stopPropagation(),function(t){var n={index:t,loop:!1,bgOpacity:1,timeToIdle:3e3,history:!0,barsSize:{top:0,bottom:0}};v=new PhotoSwipe(document.getElementById("pswp"),PhotoSwipeUI_Default,p,n),$nextBtn=$(".pswp__button--arrow--right",v.template),$prevBtn=$(".pswp__button--arrow--left",v.template),v.listen("beforeChange",function(){this.getCurrentIndex()==this.items.length-1&&e?(console.log("fetching page "+i),$nextBtn.hide(),o().done(function(){v.invalidateCurrItems(),v.updateSize(!0),e&&$nextBtn.show()})):e||$nextBtn.toggle(this.getCurrentIndex()<this.items.length-1),$prevBtn.toggle(0<this.getCurrentIndex())}),v.listen("afterChange",function(){var t=v.getCurrentIndex();if(h[t]){var n=h[t].find(".albumname:first");r.text(n.text().trim()),s.off().on("click",function(t){return t.stopPropagation(),document.location=setUrlParam({album:n.data("album")},!1,!1),!1});var i=h[t].find(".infowrapper:first").clone();i.addClass("info-viewer"),i.css({display:"block"}),l.html(i)}}),v.listen("destroy",function(){v=null}),v.init(),h[t]&&w(h[t].hasClass("infoup")?"show":"hide",0)}($(this).parents(".imgwrapper:first").data("index"))}),f.on("click",".toggle-info",function(t){t.stopPropagation(),$(this).parents(".imgwrapper:first").infoup()}),f.on("click",".infowrapper",function(t){t.stopPropagation(),$(this).parents(".imgwrapper:first").infoup()}),$("#droper").on("click",".sort-select",function(t){t.stopPropagation();var n=parseInt($(this).data("sort"));document.location=setUrlParam({by:n})})}),$(function(){var t=$("#upload_wrapper");if(!t.length)return!1;var e=new Clarifai.App({apiKey:"ea746f008b50445aa47ffb018f3d5681"});$("#albumchoice").on("change",function(t){document.location=$("body").data("path")+"/aupload/"+$(this).val()});var n=null;$("#upload_wrapper").on("focus",".tags-text",function(t){n=$(this).val()}),$("#upload_wrapper").on("blur",".tags-text",function(t){$(this).val()!=n&&$(this).save()}),$("#upload_wrapper").on("click",".save-tags",function(t){$(this).save()}),$("#upload_wrapper").on("click",".auto-tags",function(t){$(this).autoTag()}),t.find("#imagecells:first").sortable({stop:function(t,n){!function(){var t=$("#imagecells > div.imagecell");if(t.length){var n=$(t[0]).data("token"),i={};t.each(function(t){i[parseInt($(this).data("file"))]=t+1}),$.post($("body").data("path")+"/aupload/fsaveorder",{order:i,_token:n},function(t){console.log(t)})}}()}}),$.fn.autoTag=function(){var r=$(this),t=r.parents(".imagecell:first"),n=t.data("name"),s=t.find(".tags-text:first"),l=s.val();l=l?l.split(","):[];var i=$("body").data("path")+"/img/large/"+n;e.models.predict(Clarifai.GENERAL_MODEL,i).then(function(t){for(var n=0;n<t.outputs.length;n++)for(var i=t.outputs[n].data.concepts,e=0;e<i.length;e++){var o=i[e].name;.93<i[e].value&&-1==o.indexOf(",")&&-1==$.inArray(o.trim(),l)&&l.push(o)}var a=l.join(",");s.val(a),r.save()},function(t){console.log(t)})},$.fn.save=function(){var t=$(this).parents(".imagecell:first"),n=t.find(".tags-text:first").val(),i=t.data("file"),e=t.data("token");$.post($("body").data("path")+"/aupload/fsave/"+parseInt(i),{file:i,tags:n,_token:e},function(t){console.log(t)})}});